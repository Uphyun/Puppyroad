<?xml version="1.0" encoding="UTF-8"?>
<!DOCTYPE mapper PUBLIC "-//mybatis.org//DTD Mapper 3.0//EN" "https://mybatis.org/dtd/mybatis-3-mapper.dtd">
<mapper namespace="com.puppyroad.app.websocket.mapper.ChatMapper">
 <!-- 채팅방 목록 조회 -->
<select id="selectRoomList">
	SELECT    room_name,
              room_id,
              recipient,
              created_date,
              chatting_type,
              sender
    FROM      chat_room
    ORDER BY  created_date
</select>
 
<resultMap type="ChatRoomDTO" id="ChatRoomRT">
	<id column="room_id" property="roomId"/>
	<collection property="myRoomList" javaType="java.util.ArrayList" column="room_id" ofType="ChatMessageDTO" select="selectRecentMessage"/>
</resultMap>
 
 <!-- 내 채팅방 목록 조회 -->
<select id="selectMyRoomList" resultMap="ChatRoomRT">
	SELECT    room_name,
              room_id,
              recipient,
              created_date,
              chatting_type,
              sender
    FROM      chat_room
    WHERE     recipient = #{recipient}
    OR        sender = #{sender}
    ORDER BY  created_date
</select>

<!-- 최근 메세지 -->
<select id="selectRecentMessage" resultType="ChatMessageDTO">
	SELECT    room_id
	          writer,
              message,
              outgoing_date,
              attached_file,
              chatting_code
    FROM      chatting
    WHERE     (room_id, outgoing_date) IN (
           SELECT room_id, MAX(outgoing_date)
           FROM   chatting
           GROUP BY room_id)
    AND       room_id = #{roomId}
</select>


 
 <!-- 채팅방 추가 -->
<insert id="insertRoom">
        <selectKey keyProperty="roomId"
                   resultType="String"
                   order="BEFORE">
			SELECT NVL(MAX(to_number(room_id, 'xxxxxxxxxx')), 0) + 1
			FROM   chat_room
        </selectKey>
 	INSERT INTO chat_room(
 						  room_id,
 	                      room_name,
                          created_date,
                          chatting_type,
                          sender,
                          recipient)
    VALUES(
           LPAD(LTRIM(to_char(#{roomId}, 'xxxxxxxxxx')), 10, '0'),
           #{roomName},
           sysdate,
           #{chattingType},
           #{sender},
           #{recipient} 
           )
</insert>
  
  <!-- 채팅방 조회 -->
<select id="selectRoomInfo">
	SELECT    room_name,
              room_id,
              recipient,
              created_date,
              chatting_type,
              sender
    FROM      chat_room
    WHERE     room_id = #{roomId}
</select>
  
</mapper>